<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TyloAI">
    <meta name="theme-color" content="#F5F5F0">
    <title>TyloAI - AI Assistant</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #F5F5F0;
            color: #1a1a1a;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }
        
        /* Splash Screen */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #F5F5F0;
            z-index: 9999;
        }
        
        #splash.hidden {
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 35vh;
        }
        
        .logo-img {
            width: 44px;
            height: 44px;
            object-fit: contain;
        }
        
        .logo-text {
            font-size: 44px;
            font-weight: 400;
            color: #1a1a1a;
            letter-spacing: -1px;
        }
        
        .by-text {
            position: absolute;
            bottom: 100px;
            font-size: 14px;
            color: #6B6B6B;
            letter-spacing: 1px;
        }
        
        /* First Time Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            max-width: 340px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 16px;
            display: block;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
            color: #1a1a1a;
        }
        
        .modal-text {
            font-size: 15px;
            text-align: center;
            color: #6B6B6B;
            line-height: 1.5;
            margin-bottom: 24px;
        }
        
        .modal-btn {
            width: 100%;
            height: 48px;
            border-radius: 12px;
            border: none;
            background: #3B82F6;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Login Screen */
        #login {
            display: none;
            height: 100vh;
            padding: 16px;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #login.active {
            display: flex;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }
        
        .login-logo img {
            width: 36px;
            height: 36px;
        }
        
        .login-logo span {
            font-size: 36px;
            font-weight: 400;
            color: #1a1a1a;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 400;
            color: #1a1a1a;
            line-height: 1.3;
        }
        
        .login-form {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
        }
        
        .social-btn {
            width: 100%;
            height: 50px;
            border-radius: 14px;
            border: none;
            background: #000;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .divider {
            text-align: center;
            margin: 24px 0;
            color: #6B6B6B;
            font-size: 14px;
            position: relative;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #E0E0E0;
        }
        
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        
        .input-field {
            width: 100%;
            height: 50px;
            border-radius: 14px;
            border: 1px solid #E0E0E0;
            background: #fff;
            padding: 0 16px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #CA4E25;
        }
        
        .input-field::placeholder {
            color: #C0C0C0;
        }
        
        .login-btn {
            width: 100%;
            height: 50px;
            border-radius: 14px;
            border: none;
            background: #CA4E25;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .terms {
            text-align: center;
            font-size: 12px;
            color: #6B6B6B;
            margin-top: 20px;
            line-height: 1.5;
        }
        
        .terms a {
            color: #1a1a1a;
            text-decoration: underline;
        }
        
        .error-msg {
            color: #CA4E25;
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }
        
        /* Custom Checkbox */
        .custom-checkbox {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .custom-checkbox input {
            display: none;
        }
        
        .checkbox-box {
            width: 20px;
            height: 20px;
            border: 2px solid #D0D0D0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: #fff;
        }
        
        .custom-checkbox input:checked + .checkbox-box {
            background: #3B82F6;
            border-color: #3B82F6;
        }
        
        .checkbox-box svg {
            width: 12px;
            height: 12px;
            stroke: #fff;
            stroke-width: 3;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .custom-checkbox input:checked + .checkbox-box svg {
            opacity: 1;
        }
        
        .checkbox-label {
            margin-left: 8px;
            font-size: 14px;
        }
        
        /* Chat Screen */
        #chat {
            display: none;
            height: 100vh;
            flex-direction: column;
            background: #fff;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        #chat.active {
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #fff;
            border-right: 1px solid #E0E0E0;
            transition: left 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #E0E0E0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-sidebar {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .new-chat-sidebar {
            margin: 12px;
            padding: 12px;
            background: #CA4E25;
            color: #fff;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        .history-item {
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .history-item:hover {
            background: #F5F5F5;
        }
        
        .history-item.active {
            background: #F0F0F0;
        }
        
        .sidebar-footer {
            border-top: 1px solid #E0E0E0;
            padding: 16px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .user-info:hover {
            background: #F5F5F5;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #CA4E25;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-email {
            font-size: 13px;
            color: #1a1a1a;
        }
        
        .user-plan {
            font-size: 11px;
            color: #6B6B6B;
        }
        
        .settings-panel {
            display: none;
            background: #F9F9F9;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .settings-panel.active {
            display: block;
        }
        
        .settings-btn {
            width: 100%;
            padding: 10px;
            background: #fff;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .chat-header {
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E0E0E0;
            background: #fff;
            flex-shrink: 0;
        }
        
        .menu-btn {
            width: 36px;
            height: 36px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .menu-btn span {
            width: 100%;
            height: 2px;
            background: #1a1a1a;
            border-radius: 1px;
        }
        
        .header-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .model-selector {
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid #E0E0E0;
            background: #fff;
            font-size: 13px;
            cursor: pointer;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
        }
        
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            min-height: 300px;
        }
        
        .welcome-icon {
            width: 70px;
            height: 70px;
            margin-bottom: 20px;
        }
        
        .greeting {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .subgreeting {
            font-size: 16px;
            color: #6B6B6B;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .message.user .message-avatar {
            background: #E0E0E0;
            color: #1a1a1a;
        }
        
        .message.assistant .message-avatar {
            background: #3B82F6;
            color: #fff;
        }
        
        .message-content {
            flex: 1;
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .message-content pre {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .message-content code {
            background: #F5F5F5;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .message-content pre code {
            background: transparent;
            padding: 0;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        
        .message-content th,
        .message-content td {
            border: 1px solid #E0E0E0;
            padding: 8px;
            text-align: left;
        }
        
        .message-content th {
            background: #F5F5F5;
            font-weight: 600;
        }
        
        .thinking-block {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .thinking-header {
            padding: 10px 12px;
            background: #F3F4F6;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 14px;
        }
        
        .thinking-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
        }
        
        .thinking-content {
            padding: 12px;
            font-size: 14px;
            color: #6B6B6B;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .thinking-content.expanded {
            display: block;
        }
        
        .chat-input-container {
            padding: 12px 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            background: #fff;
            border-top: 1px solid #E0E0E0;
            flex-shrink: 0;
        }
        
        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background: #F5F5F5;
            border-radius: 20px;
            padding: 10px 14px;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 15px;
            outline: none;
            min-height: 20px;
        }
        
        .chat-input::placeholder {
            color: #B0B0B0;
        }
        
        .send-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3B82F6;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .send-btn:disabled {
            background: #E0E0E0;
            cursor: not-allowed;
        }
        
        .send-btn svg {
            color: #fff;
        }
        
        .usage-warning {
            font-size: 12px;
            color: #CA4E25;
            text-align: center;
            margin-top: 6px;
        }
    </style>
</head>
<body>
    <!-- First Time Modal -->
    <div class="modal-overlay" id="firstTimeModal">
        <div class="modal-content">
            <svg class="modal-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#3B82F6" opacity="0.1"/>
                <path d="M50 30V55M50 65V70" stroke="#3B82F6" stroke-width="6" stroke-linecap="round"/>
                <circle cx="50" cy="50" r="40" stroke="#3B82F6" stroke-width="4"/>
            </svg>
            <div class="modal-title">欢迎使用 TyloAI</div>
            <div class="modal-text">
                请注意：此应用版本与网页版本数据不互通，聊天记录仅保存在本地设备中。
            </div>
            <button class="modal-btn" onclick="closeFirstTimeModal()">我知道了</button>
        </div>
    </div>

    <!-- Splash Screen -->
    <div id="splash">
        <div class="logo-container">
            <img src="https://tyloai.com/logo.png" alt="TyloAI" class="logo-img" onerror="this.style.display='none'">
            <div class="logo-text">TyloAI</div>
        </div>
        <div class="by-text">BY PROTOETIC</div>
    </div>

    <!-- Login Screen -->
    <div id="login">
        <div class="login-header">
            <div class="login-logo">
                <img src="https://tyloai.com/logo.png" alt="TyloAI" onerror="this.style.display='none'">
                <span>TyloAI</span>
            </div>
            <div class="login-title">Do your best work<br>with TyloAI</div>
        </div>
        
        <div class="login-form">
            <button class="social-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>
            
            <button class="social-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                </svg>
                Continue with Apple
            </button>
            
            <div class="divider">OR</div>
            
            <input type="text" class="input-field" id="inviteCode" placeholder="Beta invite code" />
            <input type="email" class="input-field" id="email" placeholder="Personal or work email" />
            <input type="password" class="input-field" id="password" placeholder="Password" />
            
            <button class="login-btn" onclick="handleLogin()">Continue</button>
            <div class="error-msg" id="errorMsg">Invalid credentials or invite code</div>
            
            <div class="terms">
                By continuing, you agree to Protoetic's <a href="#">Consumer Terms</a> and <a href="#">Usage Policy</a>, and acknowledge their <a href="#">Privacy Policy</a>.
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Chats</div>
                <div class="close-sidebar" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </div>
            </div>
            
            <div class="new-chat-sidebar" onclick="createNewChat()">+ New Chat</div>
            
            <div class="chat-history" id="chatHistory"></div>
            
            <div class="sidebar-footer">
                <div class="user-info" onclick="toggleSettings()">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div class="user-details">
                        <div class="user-email" id="userEmail"></div>
                        <div class="user-plan">Free Plan</div>
                    </div>
                </div>
                <div class="settings-panel" id="settingsPanel">
                    <button class="settings-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </div>
        
        <!-- Main Chat -->
        <div class="chat-header">
            <div class="menu-btn" onclick="toggleSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="header-title">New chat</div>
            <select class="model-selector" id="modelSelector">
                <option value="ode-6-flash">Fast</option>
                <option value="ode-6">Advanced</option>
                <option value="ode-6-deep">Deep Think</option>
                <option value="ode-6-search">Search</option>
                <option value="ode-6-deep-search">Deep Search</option>
            </select>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-screen" id="welcomeScreen">
                <svg class="welcome-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M70 50C70 61.0457 61.0457 70 50 70C38.9543 70 30 61.0457 30 50C30 38.9543 38.9543 30 50 30C61.0457 30 70 38.9543 70 50Z" fill="#3B82F6"/>
                    <path d="M50 30C50 20 60 15 65 20C70 25 65 35 60 40" stroke="#3B82F6" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="45" cy="48" r="3" fill="white"/>
                </svg>
                <div class="greeting" id="greeting"></div>
                <div class="subgreeting">How can I help you today?</div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="chatInput" placeholder="Message TyloAI" />
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
            <div class="usage-warning" id="usageWarning" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_CONFIG = {
            baseUrl: 'https://jeniya.cn/v1',
            apiKey: 'sk-AX9opShPb1cBByrwVQwZlEP0k6xfKi7VCw375yH5RUhfG6Yc',
            models: {
                'ode-6-flash': 'gemini-2.5-flash-lite-preview-09-2025-nothinking',
                'ode-6': 'gemini-1.5-flash-002',
                'ode-6-deep': 'doubao-seed-1-6-flash-250615',
                'ode-6-search': 'gemini-2.5-flash-all',
                'ode-6-deep-search': 'deepseek-r1-searching'
            }
        };

        let currentChatId = null;
        let isProcessing = false;

        // Initialize
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splash').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    checkLoginStatus();
                }, 500);
            }, 3000);
        });

        function closeFirstTimeModal() {
            document.getElementById('firstTimeModal').classList.remove('active');
            localStorage.setItem('tyloai_app_first_time', 'false');
        }

        function showFirstTimeModal() {
            const hasSeenModal = localStorage.getItem('tyloai_app_first_time');
            if (!hasSeenModal) {
                document.getElementById('firstTimeModal').classList.add('active');
            }
        }

        function checkLoginStatus() {
            const user = JSON.parse(localStorage.getItem('tyloai_user') || 'null');
            if (user) {
                showChatScreen();
                showFirstTimeModal();
            } else {
                document.getElementById('login').classList.add('active');
            }
        }

        function handleLogin() {
            const inviteCode = document.getElementById('inviteCode').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');
            
            if (inviteCode === '1d93n4n6n32n2g3u4o2j3g4i0d' && email && password) {
                const user = { email, loggedInAt: Date.now() };
                localStorage.setItem('tyloai_user', JSON.stringify(user));
                errorMsg.style.display = 'none';
                document.getElementById('login').classList.remove('active');
                showChatScreen();
                showFirstTimeModal();
            } else {
                errorMsg.style.display = 'block';
            }
        }

        function showChatScreen() {
            document.getElementById('chat').classList.add('active');
            const user = JSON.parse(localStorage.getItem('tyloai_user'));
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').textContent = user.email[0].toUpperCase();
            updateGreeting();
            loadChatHistory();
            createNewChat();
        }

        function updateGreeting() {
            const now = new Date();
            const beijingTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            const hour = beijingTime.getHours();
            
            let greeting;
            if (hour >= 5 && hour < 12) greeting = 'Good morning.';
            else if (hour >= 12 && hour < 18) greeting = 'Good afternoon.';
            else greeting = 'Good evening.';
            
            document.getElementById('greeting').textContent = greeting;
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('active');
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('tyloai_user');
                location.reload();
            }
        }

        function createNewChat() {
            currentChatId = 'chat_' + Date.now();
            document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-screen">
                    <svg class="welcome-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M70 50C70 61.0457 61.0457 70 50 70C38.9543 70 30 61.0457 30 50C30 38.9543 38.9543 30 50 30C61.0457 30 70 38.9543 70 50Z" fill="#3B82F6"/>
                        <path d="M50 30C50 20 60 15 65 20C70 25 65 35 60 40" stroke="#3B82F6" stroke-width="4" stroke-linecap="round"/>
                        <circle cx="45" cy="48" r="3" fill="white"/>
                    </svg>
                    <div class="greeting" id="greeting"></div>
                    <div class="subgreeting">How can I help you today?</div>
                </div>
            `;
            updateGreeting();
            saveCurrentChat();
            loadChatHistory();
            if (document.getElementById('sidebar').classList.contains('active')) {
                toggleSidebar();
            }
        }

        function loadChatHistory() {
            const chats = JSON.parse(localStorage.getItem('tyloai_chats') || '[]');
            const historyEl = document.getElementById('chatHistory');
            historyEl.innerHTML = chats.map(chat => `
                <div class="history-item ${chat.id === currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                    ${chat.title || 'New chat'}
                </div>
            `).join('');
        }

        function loadChat(chatId) {
            const chats = JSON.parse(localStorage.getItem('tyloai_chats') || '[]');
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            
            currentChatId = chatId;
            const messagesEl = document.getElementById('chatMessages');
            messagesEl.innerHTML = '';
            
            chat.messages.forEach(msg => {
                addMessageToUI(msg.role, msg.content, msg.thinking);
            });
            
            loadChatHistory();
            toggleSidebar();
        }

        function saveCurrentChat() {
            const chats = JSON.parse(localStorage.getItem('tyloai_chats') || '[]');
            const messagesEl = document.getElementById('chatMessages');
            const messages = Array.from(messagesEl.querySelectorAll('.message')).map(el => ({
                role: el.classList.contains('user') ? 'user' : 'assistant',
                content: el.querySelector('.message-content').textContent,
                thinking: el.querySelector('.thinking-content')?.textContent || null
            }));
            
            const existingIndex = chats.findIndex(c => c.id === currentChatId);
            const title = messages[0]?.content.substring(0, 50) || 'New chat';
            
            if (existingIndex >= 0) {
                chats[existingIndex] = { id: currentChatId, title, messages, updatedAt: Date.now() };
            } else {
                chats.unshift({ id: currentChatId, title, messages, createdAt: Date.now() });
            }
            
            localStorage.setItem('tyloai_chats', JSON.stringify(chats.slice(0, 50)));
        }

        async function sendMessage() {
            if (isProcessing) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const selectedModel = document.getElementById('modelSelector').value;
            
            // Check ode-6 usage limit
            if (selectedModel === 'ode-6') {
                const today = new Date().toDateString();
                const usage = JSON.parse(localStorage.getItem('tyloai_ode6_usage') || '{}');
                if (usage.date !== today) {
                    usage.date = today;
                    usage.count = 0;
                }
                if (usage.count >= 10) {
                    document.getElementById('usageWarning').textContent = 'Daily limit reached for Advanced model (10/10)';
                    document.getElementById('usageWarning').style.display = 'block';
                    return;
                }
                usage.count++;
                localStorage.setItem('tyloai_ode6_usage', JSON.stringify(usage));
                document.getElementById('usageWarning').textContent = `Advanced model usage: ${usage.count}/10 today`;
                document.getElementById('usageWarning').style.display = 'block';
            } else {
                document.getElementById('usageWarning').style.display = 'none';
            }
            
            input.value = '';
            isProcessing = true;
            document.getElementById('sendBtn').disabled = true;
            
            // Remove welcome screen
            const welcome = document.querySelector('.welcome-screen');
            if (welcome) welcome.remove();
            
            // Add user message
            addMessageToUI('user', message);
            
            // Add assistant message placeholder
            const assistantMsgEl = addMessageToUI('assistant', '');
            const contentEl = assistantMsgEl.querySelector('.message-content');
            
            try {
                const systemPrompt = getSystemPrompt(selectedModel);
                const response = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.models[selectedModel],
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: message }
                        ],
                        stream: true,
                        temperature: 0.7
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                let thinkingText = '';
                let isThinking = false;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim().startsWith('data:'));
                    
                    for (const line of lines) {
                        const data = line.replace('data: ', '').trim();
                        if (data === '[DONE]') break;
                        
                        try {
                            const parsed = JSON.parse(data);
                            const content = parsed.choices[0]?.delta?.content || '';
                            
                            // Handle thinking blocks for deep models
                            if (selectedModel.includes('deep') && content) {
                                if (content.includes('<think>')) {
                                    isThinking = true;
                                    thinkingText = '';
                                } else if (content.includes('</think>')) {
                                    isThinking = false;
                                    if (thinkingText) {
                                        addThinkingBlock(assistantMsgEl, thinkingText);
                                        thinkingText = '';
                                    }
                                } else if (isThinking) {
                                    thinkingText += content;
                                } else {
                                    fullText += content;
                                    contentEl.innerHTML = marked.parse(fullText);
                                    hljs.highlightAll();
                                }
                            } else {
                                fullText += content;
                                contentEl.innerHTML = marked.parse(fullText);
                                hljs.highlightAll();
                            }
                            
                            scrollToBottom();
                        } catch (e) {}
                    }
                }
                
            } catch (error) {
                contentEl.textContent = 'Error: Unable to process your request. Please try again.';
                console.error('API Error:', error);
            }
            
            isProcessing = false;
            document.getElementById('sendBtn').disabled = false;
            saveCurrentChat();
        }

        function getSystemPrompt(model) {
            const base = "You are TyloAI, an advanced AI assistant created by Protoetic. You are helpful, creative, and provide detailed responses. Format your responses using markdown with proper headings, lists, code blocks, and tables when appropriate.";
            
            if (model === 'ode-6-search' || model === 'ode-6-deep-search') {
                return base + " IMPORTANT: You MUST search the internet for current information to answer the user's question. Always use web search capabilities.";
            }
            
            return base;
        }

        function addMessageToUI(role, content, thinking = null) {
            const messagesEl = document.getElementById('chatMessages');
            const msgEl = document.createElement('div');
            msgEl.className = `message ${role}`;
            
            const avatar = role === 'user' 
                ? document.getElementById('userEmail').textContent[0].toUpperCase()
                : 'AI';
            
            msgEl.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${marked.parse(content)}</div>
            `;
            
            messagesEl.appendChild(msgEl);
            
            if (thinking) {
                addThinkingBlock(msgEl, thinking);
            }
            
            hljs.highlightAll();
            scrollToBottom();
            return msgEl;
        }

        function addThinkingBlock(messageEl, thinkingContent) {
            const existingThinking = messageEl.querySelector('.thinking-block');
            if (existingThinking) return;
            
            const thinkingEl = document.createElement('div');
            thinkingEl.className = 'thinking-block';
            thinkingEl.innerHTML = `
                <div class="thinking-header" onclick="this.nextElementSibling.classList.toggle('expanded')">
                    <span>
                        <svg class="thinking-icon" style="display: inline-block; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"/>
                            <circle cx="19" cy="12" r="1"/>
                            <circle cx="5" cy="12" r="1"/>
                        </svg>
                        思考过程
                    </span>
                    <span>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </span>
                </div>
                <div class="thinking-content">${thinkingContent}</div>
            `;
            
            messageEl.querySelector('.message-content').prepend(thinkingEl);
        }

        function scrollToBottom() {
            const messages = document.getElementById('chatMessages');
            messages.scrollTop = messages.scrollHeight;
        }

        // Enter to send
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Enter to login
        document.querySelectorAll('.input-field').forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        });

        // Configure marked
        marked.setOptions({
            breaks: true,
            gfm: true
        });
    </script>
</body>
</html>